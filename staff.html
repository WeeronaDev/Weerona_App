<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Weerona Late Meals</title>
	<link rel="icon" href="favicon.ico" type="image/x-icon" />
	<link rel="stylesheet" type="text/css" href="css_staff.css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
	<script async>
		// Initialize Firebase
		$(function() {
			console.log("initialize database");
			var config = {
				apiKey: "AIzaSyCu-niq7rlwyF6PGbrwNPzy9BSzP6o6z5M",
				authDomain: "weeronaapp.firebaseapp.com",
				databaseURL: "https://weeronaapp.firebaseio.com",
				projectId: "weeronaapp",
				storageBucket: "weeronaapp.appspot.com",
				messagingSenderId: "1093710876765"
			};
			firebase.initializeApp(config);
			var database = firebase.database();
		});
	</script>
</head>

<body>

	<script>
		//Prevent default submit when enter is pressed
		$(document).ready(function() {
			$(window).keydown(function(event){
				if(event.keyCode == 13) {
					event.preventDefault();
					return false;
				}
			});
		});

		$(function() {		
			//On page load.	
			firebase.auth().onAuthStateChanged(function(user) {
				if (user) {
					//User is signed in - get alias.
					firebase.database().ref().child('users/'+user.uid).once("value", function(snap) {
						var alias = snap.val().alias;
						console.log("alias: "+alias);
						console.log("initial auth: user logged in as "+user.displayName);	
						$("#welcomeText").html("Logged in as: "+alias+" ("+user.email+")");
						$("#welcome_banner").show();
					});						
					//Check if user is admin				
					firebase.database().ref().child('admins/'+user.uid).once("value", function(snapshot) {
						console.log(snapshot.val());
						if (snapshot.val() != null) {
							console.log("IS ADMIN");

							//Fetch menu headers.
							firebase.database().ref().child('options').once("value", function(snap) {
								$("#optionText1").html(snap.val().option1);
								$("#optionText2").html(snap.val().option2);
								$("#optionText3").html(snap.val().option3);
								$("#optionText4").html(snap.val().option4);
								$("#optionText5").html(snap.val().option5);
								$("#optionText6").html(snap.val().option6);
								$("#optionText7").html(snap.val().option7);
							});	

							//Fetch orders list.
							firebase.database().ref().child('orders').on('child_added', function(snap) {								
								console.log("Meals 'n' shit.")
								var tr = $("<tr></tr>");
								tr.append($("<td></td>").text(snap.val().lastUpdate));
								tr.append($("<td></td>").text(snap.val().username));
								tr.append($("<td></td>").text(snap.val().option1));
								tr.append($("<td></td>").text(snap.val().option2));
								tr.append($("<td></td>").text(snap.val().option3));
								tr.append($("<td></td>").text(snap.val().option4));
								tr.append($("<td></td>").text(snap.val().option5));
								tr.append($("<td></td>").text(snap.val().option6));
								tr.append($("<td></td>").text(snap.val().option7));
								$("#orders").append(tr);
								console.log("retrieved meals");
								$("#noData").hide();																				
							});							

							//Get last update time.
							var currentDate = new Date(); 
							var date = currentDate.getDate() + "/"
							+ (currentDate.getMonth()+1)  + "/" 
							+ currentDate.getFullYear();
							var time = currentDate.getHours() + ":"  
							+ currentDate.getMinutes() + ":" 
							+ currentDate.getSeconds();	
							$("#lastRefresh").html(date+" "+time);
							$("#content").show();
						} else {
							console.log("NOT ADMIN");
							$("#errorText").html("You do not have permission to view this page.");
							$("#error_banner").show();					
						}
					});
				} else {
					// No user is signed in.
					console.log("initial auth: user not logged in");	
					$("#login_banner").show();
					$("#errorText").html("Please log-in to access the content on this page.");
					$("#error_banner").show();
				}
			});

			

			//Delete orders - button operation.
			document.getElementById("btnDelete").addEventListener("click", function(submit) {	
				submit.preventDefault();
				$("#btnDelete").hide();
				$("#deleteWarn").show();
			});
			document.getElementById("btnCancelDel").addEventListener("click", function(submit) {
				submit.preventDefault();	
				$("#btnDelete").show();
				$("#deleteWarn").hide();
			});	
			document.getElementById("btnDeleteAll").addEventListener("click", function(submit) {	
				submit.preventDefault();
				firebase.database().ref().child('orders').remove().then(function() {
					location.reload();			
				}).catch(function(error) {
					$("#errorText").html("There was a problem clearing orders. Try refreshing the page.");
					$("#error_banner").show();
				});
			});

			//Change menu - button operations
			document.getElementById("btnChangeMenu").addEventListener("click", function(submit) {	
				submit.preventDefault();
				$("#viewMenu").hide();
				$("#changeMenu").show();
			});
			document.getElementById("btnChangeCancel").addEventListener("click", function(submit) {	
				submit.preventDefault();
				$("#viewMenu").show();
				$("#changeMenu").hide();
			});
			//Update menu
			document.getElementById("btnSetMenu").addEventListener("click", function(submit) {
				submit.preventDefault();				
				var menuOption1 = $("#menuOption1").val().trim();
				var menuOption2 = $("#menuOption2").val().trim();
				var menuOption3 = $("#menuOption3").val().trim();
				var menuOption4 = $("#menuOption4").val().trim();
				var menuOption5 = $("#menuOption5").val().trim();
				var menuOption6 = $("#menuOption6").val().trim();
				var menuOption7 = $("#menuOption7").val().trim();

				//Check all fields are filled in
				if (!menuOption1||!menuOption2||!menuOption3||!menuOption4||!menuOption5||!menuOption6||!menuOption7) {
					console.log("invalid input");
					$("#submitError").show();
				} else {					
					firebase.database().ref().child("options").update({
						option1: menuOption1,
						option2: menuOption2,
						option3: menuOption3,
						option4: menuOption4,
						option5: menuOption5,
						option6: menuOption6,
						option7: menuOption7
					});
					location.reload();
				}									
			});

			//Page navigation buttons	
			document.getElementById("btnStudent").addEventListener("click", function(submit) {	
				window.location.replace("student.html");
			});
			document.getElementById("btnLogin").addEventListener("click", function(submit) {	
				window.location.replace("index.html");
			});


			//Sign-out
			document.getElementById("btnLogout").addEventListener("click", function(signOut) {	
				firebase.auth().signOut().then(function() {	
					window.location.replace("index.html");				
				}).catch(function(error) {
					$("#errorText").html("There was a problem signing you out.");
					$("#error_banner").show();
				});
			});
		});
	</script>
	
	<div id="header">
		<img src="png/LOGO2.png" alt="Weerona Logo" height="100" width="236">
		<h1>Staff View</h1>
	</div>

	<div id="login_banner" class="banner">
		<p>You are not logged in.</p>
		<form action="index.html">
			<input type="submit" value="Log-In" />
		</form>
	</div>
	
	<div id="welcome_banner" class="banner">
		<p id="welcomeText"></p>
		<input type="submit" id="btnLogout" name="logout" value ="Log-Out">
	</div>
	
	<div id="logout_banner" class="banner">
		<p>You have been logged out.</p>
	</div>
	
	<div id="error_banner" class="banner">
		<p id="errorText"></p>
	</div>

	<div id="content">
		<div id="viewMenu">
			<h3><img id='meal_icon' src="calendar-60x60.png" alt="Meal calendar" style="width:60px;height:60px;">VIEW LATE MEAL ORDERS</h3>
			<p><b>Pending late meal orders:</b></p>
			<br>
			<table id="orders">
				<tr>
					<th>Submitted</th>
					<th>Name</th>
					<th><p id="optionText1"></p></th>
					<th><p id="optionText2"></p></th>
					<th><p id="optionText3"></p></th>
					<th><p id="optionText4"></p></th>
					<th><p id="optionText5"></p></th>
					<th><p id="optionText6"></p></th>
					<th><p id="optionText7"></p></th>
				</tr>
			</table>
			<br>
			<p id="noData"><b>No orders to show.</b></p>
			<br>

			<div id="deleteWarn" class="warn hidden">
				<p><b>WARNING: This will permanently erase all late meal orders! Continue?</b></p>
				<input type="submit" id="btnDeleteAll" name="delconfirm" value ="Delete Orders">
				<input type="submit" id="btnCancelDel" name="delcancel" value ="Cancel">
			</div>

			<input type="submit" id="btnDelete" name="delete" value ="Clear Order List">
			<br><br>
			<input type="submit" id="btnChangeMenu" name="opensetmenu" value ="Update Menu">
			<br><br>
			<p><b>Reload the page to refresh orders list.</b></p>
			<br>
		</div>

		<div id="changeMenu" class="hidden">
			<h3>CHANGE MENU</h3>
			<p>Option 1:</p>
			<input type="text" id="menuOption1" name="name"><br><br>
			<p>Option 2:</p>
			<input type="text" id="menuOption2" name="name"><br><br>
			<p>Option 3:</p>
			<input type="text" id="menuOption3" name="name"><br><br>
			<p>Option 4:</p>
			<input type="text" id="menuOption4" name="name"><br><br>
			<p>Option 5:</p>
			<input type="text" id="menuOption5" name="name"><br><br>
			<p>Option 6:</p>
			<input type="text" id="menuOption6" name="name"><br><br>
			<p>Option 7:</p>
			<input type="text" id="menuOption7" name="name"><br><br>

			<p><b>NOTE: Option selections in existing orders will not be affected.</b></p><br>
		
			<p id="submitError" class="warn hidden"><b>All meal options must be set to update menu!</b></p><br>		
			<input type="submit" id="btnSetMenu" name="setmenu" value ="Apply Changes">
			<input type="submit" id="btnChangeCancel" name="cancelsetmenu" value ="Cancel">
		</div>

		<br>
		<p><b>Orders current at:</b></p>
		<p id="lastRefresh"></p>

		<br><br>
		<p><b>Navigation:</b></p>
		<input type="submit" id="btnLogin" value ="Return to Login Page - No sign-out">
		<input type="submit" id="btnStudent" value ="View as Student">
	</div>	
</body>
</html>